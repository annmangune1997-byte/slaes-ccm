<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cancelled Order Management System - CRISPY CHICKEN</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #ff6b35;
      --secondary: #f7931e;
      --success: #28a745;
      --danger: #dc3545;
      --info: #17a2b8;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #343a40;
      --white: #fff;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      direction: ltr;
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      width: 95%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--white);
      padding: 30px 0;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,144C960,149,1056,139,1152,122.7C1248,107,1344,85,1392,74.7L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
      background-size: cover;
    }

    h1 {
      text-align: center;
      font-size: 2.8rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      position: relative;
      z-index: 1;
    }

    .subtitle {
      text-align: center;
      font-size: 1.3rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    .card {
      background: var(--white);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      padding: 30px;
      margin-bottom: 30px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      border-bottom: 2px solid var(--light);
      padding-bottom: 15px;
    }

    .card-title {
      font-size: 1.8rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title i {
      font-size: 1.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: var(--transition);
      background: var(--white);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
    }

    .datetime-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }

    .btn-primary:hover {
      background: #e55a2b;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
    }

    .btn-success {
      background: var(--success);
      color: var(--white);
    }

    .btn-success:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }

    .btn-danger {
      background: var(--danger);
      color: var(--white);
    }

    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }

    .btn-info {
      background: var(--info);
      color: var(--white);
    }

    .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
      color: var(--white);
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-top: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--white);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: pulse 3s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.1); opacity: 0.3; }
    }

    .stat-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 20px 40px rgba(255, 107, 53, 0.4);
    }

    .stat-card.success {
      background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
    }

    .stat-card.danger {
      background: linear-gradient(135deg, var(--danger) 0%, #f86c6b 100%);
    }

    .stat-card.info {
      background: linear-gradient(135deg, var(--info) 0%, #4dabf7 100%);
    }

    .stat-card.warning {
      background: linear-gradient(135deg, var(--warning) 0%, #ffd43b 100%);
    }

    .stat-card h3 {
      font-size: 3rem;
      margin: 15px 0;
      font-weight: 900;
      position: relative;
      z-index: 1;
    }

    .stat-card p {
      font-size: 1.2rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    .stat-card i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.8;
    }

    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
    }

    .filter-group input, .filter-group select {
      flex: 1;
      min-width: 200px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: var(--white);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    th, td {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #e0e0e0;
    }

    th {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--white);
      font-weight: 700;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .actions .btn {
      padding: 8px 12px;
      font-size: 0.9rem;
    }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: var(--white);
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translate(100%, 0);
        opacity: 0;
      }
      to {
        transform: translate(0, 0);
        opacity: 1;
      }
    }

    .notification.show {
      display: flex;
    }

    .notification.error {
      background: var(--danger);
    }

    .notification.info {
      background: var(--info);
    }

    .badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .badge-success {
      background: var(--success);
      color: var(--white);
    }

    .badge-danger {
      background: var(--danger);
      color: var(--white);
    }

    .badge-warning {
      background: var(--warning);
      color: #212529;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--white);
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-height: 80vh;
      overflow-y: auto;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      left: 15px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
    }

    .close-modal:hover {
      color: var(--danger);
    }

    .export-section {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .export-section .btn {
      flex: 1;
      min-width: 200px;
    }

    .chart-container {
      position: relative;
      height: 350px;
      margin: 20px 0;
      background: var(--white);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 15px;
      text-align: center;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-top: 30px;
    }

    .pivot-table {
      width: 100%;
      overflow-x: auto;
      margin: 20px 0;
    }

    .pivot-table table {
      min-width: 100%;
      font-size: 0.9rem;
    }

    .pivot-table th {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .pivot-table .highlight {
      background-color: rgba(255, 107, 53, 0.2);
      font-weight: bold;
    }

    .reason-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .reason-table th, .reason-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .reason-table th {
      background: var(--light);
      font-weight: 600;
    }

    .reason-table tr:nth-child(even) {
      background: #f8f9fa;
    }

    .reason-table tr:hover {
      background: #e9ecef;
    }

    .time-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .time-filter button {
      padding: 8px 15px;
      border: 1px solid var(--primary);
      background: var(--white);
      color: var(--primary);
      border-radius: 5px;
      cursor: pointer;
      transition: var(--transition);
    }

    .time-filter button.active {
      background: var(--primary);
      color: var(--white);
    }

    .time-filter button:hover {
      background: var(--primary);
      color: var(--white);
    }

    .fixed-brand {
      background-color: rgba(255, 107, 53, 0.1);
      border: 2px solid var(--primary);
      color: var(--primary);
      font-weight: bold;
      cursor: not-allowed;
    }

    .location-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ff6b35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 40px;
    }

    .reason-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ff6b35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 40px;
    }

    .status-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ff6b35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M9 11l3 3L22 4'%3E%3C/path%3E%3Cpath d='M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 40px;
    }

    .agent-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ff6b35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'%3E%3C/path%3E%3Ccircle cx='12' cy='7' r='4'%3E%3C/circle%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 40px;
    }

    .channel-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ff6b35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M4 6h16M4 12h16M4 18h7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 40px;
    }

    .datetime-input {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ff6b35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cpolyline points='12 6 12 12 16 14'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      padding-left: 40px;
    }

    .custom-reason {
      display: none;
      margin-top: 15px;
    }

    .custom-reason.show {
      display: block;
    }

    .reason-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-right: 5px;
    }

    .reason-badge.customer {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .reason-badge.driver {
      background-color: #fff3e0;
      color: #f57c00;
    }

    .reason-badge.delivery {
      background-color: #f3e5f5;
      color: #7b1fa2;
    }

    .reason-badge.restaurant {
      background-color: #e8f5e9;
      color: #388e3c;
    }

    .reason-badge.payment {
      background-color: #ffebee;
      color: #c62828;
    }

    .reason-badge.other {
      background-color: #fafafa;
      color: #616161;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-weight: 600;
    }

    .status-badge.accepted {
      color: var(--success);
    }

    .status-badge.not-accepted {
      color: var(--danger);
    }

    .whatsapp-report {
      background: #f0f2f5;
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      border-left: 5px solid #25d366;
    }

    .whatsapp-report h3 {
      color: #25d366;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .whatsapp-report-content {
      background: white;
      border-radius: 10px;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      white-space: pre-line;
      overflow-x: auto;
    }

    .whatsapp-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .whatsapp-actions .btn {
      flex: 1;
    }

    .date-picker {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .date-picker input {
      flex: 1;
    }

    .date-picker button {
      padding: 12px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .date-picker button:hover {
      background: #e55a2b;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .kpi-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .kpi-card h4 {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 5px;
    }

    .kpi-card .value {
      font-size: 1.8rem;
      font-weight: bold;
    }

    .kpi-card .change {
      font-size: 0.85rem;
      margin-top: 5px;
      opacity: 0.8;
    }

    .kpi-card.positive .change {
      color: #4ade80;
    }

    .kpi-card.negative .change {
      color: #f87171;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      .charts-grid {
        grid-template-columns: 1fr;
      }
      
      .filter-group {
        flex-direction: column;
      }
      
      table {
        font-size: 0.9rem;
      }
      
      th, td {
        padding: 10px 5px;
      }
      
      .pivot-table table {
        font-size: 0.8rem;
      }
      
      .datetime-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Cancelled Order Management System</h1>
    <p class="subtitle">CRISPY CHICKEN - Comprehensive order tracking and analytics</p>
  </header>

  <!-- Add Order Form -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-plus-circle"></i>
        Add New Order
      </h2>
    </div>
    <form id="orderForm">
      <div class="form-grid">
        <div class="form-group">
          <label for="brand">Brand</label>
          <input type="text" id="brand" value="CRISPY CHICKEN" class="fixed-brand" disabled>
        </div>
        <div class="form-group">
          <label for="channel">Channel</label>
          <select id="channel" class="channel-select" required>
            <option value="">Select Channel</option>
            <option value="ONLY DELIVERY">ONLY DELIVERY</option>
            <option value="ONLINE-PICK-UP">ONLINE-PICK-UP</option>
          </select>
        </div>
        <div class="form-group">
          <label for="orderNumber">Order Number</label>
          <input type="text" id="orderNumber" placeholder="e.g., ORD-2024-001" required>
        </div>
        <div class="form-group">
          <label for="agentName">Agent Name</label>
          <select id="agentName" class="agent-select" required>
            <option value="">Select Agent</option>
            <option value="ANN">ANN</option>
            <option value="MANJO">MANJO</option>
            <option value="NONA">NONA</option>
            <option value="SHALH">SHALH</option>
            <option value="ASH">ASH</option>
            <option value="MELIVEN">MELIVEN</option>
            <option value="KENAWY">KENAWY</option>
          </select>
        </div>
        <div class="form-group">
          <label for="branch">Location</label>
          <select id="branch" class="location-select" required>
            <option value="">Select Location</option>
            <option value="Barsha">Barsha</option>
            <option value="Electra">Electra</option>
            <option value="Hamdan">Hamdan</option>
            <option value="Khalydiha">Khalydiha</option>
            <option value="Mouroor">Mouroor</option>
            <option value="Shabiha">Shabiha</option>
            <option value="Satwa">Satwa</option>
            <option value="ALRIGGA">ALRIGGA</option>
            <option value="SHARJA">SHARJA</option>
          </select>
        </div>
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" required onchange="toggleReasonStatus()">
            <option value="">Select Status</option>
            <option value="cancelled">Cancelled</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>
        <div class="form-group">
          <label for="price">Order Price (AED)</label>
          <input type="number" id="price" step="0.01" min="0" required>
        </div>
        <div class="form-group">
          <label for="count">Number of Orders</label>
          <input type="number" id="count" min="1" value="1" required>
        </div>
        <div class="form-group datetime-group">
          <div>
            <label for="orderDate">Order Date</label>
            <input type="date" id="orderDate" class="datetime-input" required>
          </div>
          <div>
            <label for="orderTime">Order Time</label>
            <input type="time" id="orderTime" class="datetime-input" required>
          </div>
        </div>
        <div class="form-group" id="reasonGroup" style="display: none;">
          <label for="reason">Reason for Cancellation</label>
          <select id="reason" class="reason-select" onchange="toggleCustomReason()">
            <option value="">Select Reason</option>
            <option value="Customer not available">Customer not available</option>
            <option value="Customer cancelled the order">Customer cancelled the order</option>
            <option value="Driver delayed">Driver delayed</option>
            <option value="Delivery issue">Delivery issue</option>
            <option value="Wrong order prepared">Wrong order prepared</option>
            <option value="Restaurant closed early">Restaurant closed early</option>
            <option value="Payment method not available">Payment method not available</option>
            <option value="Other reason (with details)">Other reason (with details)</option>
          </select>
        </div>
        <div class="form-group custom-reason" id="customReasonGroup">
          <label for="customReason">Please specify the reason</label>
          <input type="text" id="customReason" placeholder="e.g., Customer changed their mind">
        </div>
        <div class="form-group" id="reasonStatusGroup" style="display: none;">
          <label for="reasonStatus">Reason Status</label>
          <select id="reasonStatus" class="status-select">
            <option value="">Select Status</option>
            <option value="ŸÖŸÇÿ®ŸàŸÑ ‚úÖ">ŸÖŸÇÿ®ŸàŸÑ ‚úÖ (Accepted - Valid/Justified)</option>
            <option value="ÿ∫Ÿäÿ± ŸÖŸÇÿ®ŸàŸÑ ‚ùå">ÿ∫Ÿäÿ± ŸÖŸÇÿ®ŸàŸÑ ‚ùå (Not Accepted - Unjustified)</option>
          </select>
        </div>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i>
          Add Order
        </button>
        <button type="button" class="btn btn-secondary" onclick="setDateTimeNow()">
          <i class="fas fa-clock"></i>
          Use Current Date & Time
        </button>
      </div>
    </form>
  </div>

  <!-- Enhanced Dashboard -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-chart-line"></i>
        Enhanced Dashboard
      </h2>
    </div>
    
    <!-- KPI Cards -->
    <div class="kpi-grid">
      <div class="kpi-card positive">
        <h4>Today's Orders</h4>
        <div class="value" id="todayOrders">0</div>
        <div class="change" id="todayOrdersChange">+0%</div>
      </div>
      <div class="kpi-card negative">
        <h4>Today's Cancellations</h4>
        <div class="value" id="todayCancellations">0</div>
        <div class="change" id="todayCancellationsChange">+0%</div>
      </div>
      <div class="kpi-card positive">
        <h4>Avg Order Value</h4>
        <div class="value" id="avgOrderValue">AED 0</div>
        <div class="change" id="avgOrderValueChange">+0%</div>
      </div>
      <div class="kpi-card negative">
        <h4>Unjustified Rate</h4>
        <div class="value" id="unjustifiedRate">0%</div>
        <div class="change" id="unjustifiedRateChange">+0%</div>
      </div>
    </div>

    <!-- Main Dashboard Cards -->
    <div class="dashboard">
      <div class="stat-card">
        <i class="fas fa-shopping-cart fa-2x"></i>
        <h3 id="totalOrders">0</h3>
        <p>Total Orders</p>
      </div>
      <div class="stat-card danger">
        <i class="fas fa-times-circle fa-2x"></i>
        <h3 id="cancelledOrders">0</h3>
        <p>Cancelled Orders</p>
      </div>
      <div class="stat-card success">
        <i class="fas fa-check-circle fa-2x"></i>
        <h3 id="deliveredOrders">0</h3>
        <p>Delivered Orders</p>
      </div>
      <div class="stat-card warning">
        <i class="fas fa-percentage fa-2x"></i>
        <h3 id="cancellationRate">0%</h3>
        <p>Cancellation Rate</p>
      </div>
      <div class="stat-card danger">
        <i class="fas fa-exclamation-triangle fa-2x"></i>
        <h3 id="unjustifiedCancellations">0</h3>
        <p>Unjustified Cancellations</p>
      </div>
      <div class="stat-card info">
        <i class="fas fa-money-bill-wave fa-2x"></i>
        <h3 id="totalRevenue">AED 0.00</h3>
        <p>Total Revenue</p>
      </div>
    </div>
    
    <!-- Enhanced Charts -->
    <div class="charts-grid">
      <div class="chart-container">
        <div class="chart-title">Order Status Distribution</div>
        <canvas id="statusChart"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Cancellation Rate by Channel</div>
        <canvas id="channelChart"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Orders by Location</div>
        <canvas id="locationChart"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Performance Trend (Last 7 Days)</div>
        <canvas id="trendChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Daily Report for WhatsApp -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fab fa-whatsapp"></i>
        Daily WhatsApp Report
      </h2>
    </div>
    <div class="date-picker">
      <label for="reportDate">Select Date:</label>
      <input type="date" id="reportDate" value="">
      <button onclick="generateWhatsAppReport()">
        <i class="fas fa-file-alt"></i>
        Generate Report
      </button>
    </div>
    <div id="whatsappReportContainer" style="display: none;">
      <div class="whatsapp-report">
        <h3><i class="fab fa-whatsapp"></i> WhatsApp Report Template</h3>
        <div class="whatsapp-report-content" id="whatsappReportContent"></div>
        <div class="whatsapp-actions">
          <button class="btn btn-success" onclick="copyToClipboard()">
            <i class="fas fa-copy"></i>
            Copy to Clipboard
          </button>
          <button class="btn btn-info" onclick="openWhatsApp()">
            <i class="fab fa-whatsapp"></i>
            Send via WhatsApp
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pivot Table -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-table"></i>
        Pivot Table: Orders by Location and Channel
      </h2>
    </div>
    <div class="pivot-table">
      <table id="pivotTable">
        <thead>
          <tr>
            <th>Location</th>
            <th>ONLY DELIVERY</th>
            <th>ONLINE-PICK-UP</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="pivotTableBody">
          <!-- Generated dynamically -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Top Unacceptable Reasons -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-exclamation-triangle"></i>
        Top Unacceptable Reasons
      </h2>
    </div>
    <div class="time-filter">
      <button class="active" onclick="filterReasons('all')">All Time</button>
      <button onclick="filterReasons('week')">Last Week</button>
      <button onclick="filterReasons('month')">Last Month</button>
    </div>
    <table class="reason-table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Reason Category</th>
          <th>Reason</th>
          <th>Count</th>
          <th>Percentage</th>
        </tr>
      </thead>
      <tbody id="reasonsTable">
        <!-- Generated dynamically -->
      </tbody>
    </table>
  </div>

  <!-- Filters -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-filter"></i>
        Search & Filter
      </h2>
    </div>
    <div class="filter-group">
      <select id="filterBranch">
        <option value="">All Locations</option>
        <option value="Barsha">Barsha</option>
        <option value="Electra">Electra</option>
        <option value="Hamdan">Hamdan</option>
        <option value="Khalydiha">Khalydiha</option>
        <option value="Mouroor">Mouroor</option>
        <option value="Shabiha">Shabiha</option>
        <option value="Satwa">Satwa</option>
        <option value="ALRIGGA">ALRIGGA</option>
        <option value="SHARJA">SHARJA</option>
      </select>
      <input type="text" id="filterSearch" placeholder="Global search (order number/channel/reason/agent)">
      <select id="filterChannel">
        <option value="">All Channels</option>
        <option value="ONLY DELIVERY">ONLY DELIVERY</option>
        <option value="ONLINE-PICK-UP">ONLINE-PICK-UP</option>
      </select>
      <select id="filterAgent">
        <option value="">All Agents</option>
        <option value="ANN">ANN</option>
        <option value="MANJO">MANJO</option>
        <option value="NONA">NONA</option>
        <option value="SHALH">SHALH</option>
        <option value="ASH">ASH</option>
        <option value="MELIVEN">MELIVEN</option>
        <option value="KENAWY">KENAWY</option>
      </select>
      <select id="filterStatus">
        <option value="">All Statuses</option>
        <option value="cancelled">Cancelled</option>
        <option value="delivered">Delivered</option>
      </select>
      <select id="filterReasonStatus">
        <option value="">All Reason Statuses</option>
        <option value="ŸÖŸÇÿ®ŸàŸÑ ‚úÖ">ŸÖŸÇÿ®ŸàŸÑ ‚úÖ (Accepted)</option>
        <option value="ÿ∫Ÿäÿ± ŸÖŸÇÿ®ŸàŸÑ ‚ùå">ÿ∫Ÿäÿ± ŸÖŸÇÿ®ŸàŸÑ ‚ùå (Not Accepted)</option>
      </select>
      <button class="btn btn-info" onclick="resetFilters()">
        <i class="fas fa-redo"></i>
        Reset Filters
      </button>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">
        <i class="fas fa-table"></i>
        Orders
      </h2>
    </div>
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Brand</th>
            <th>Order Number</th>
            <th>Channel</th>
            <th>Agent Name</th>
            <th>Location</th>
            <th>Status</th>
            <th>Order Price</th>
            <th>Number of Orders</th>
            <th>Order Date</th>
            <th>Order Time</th>
            <th>Reason for Cancellation</th>
            <th>Reason Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="ordersTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Export Options -->
  <div class="export-section">
    <button class="btn btn-success" onclick="exportToCSV()">
      <i class="fas fa-file-csv"></i>
      Export CSV
    </button>
    <button class="btn btn-info" onclick="exportToPDF()">
      <i class="fas fa-file-pdf"></i>
      Export PDF
    </button>
    <button class="btn btn-primary" onclick="exportToJSON()">
      <i class="fas fa-file-code"></i>
      Export JSON
    </button>
  </div>
</div>

<!-- Notifications -->
<div id="notification" class="notification">
  <i class="fas fa-check-circle"></i>
  <span id="notificationText"></span>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeEditModal()">
      <i class="fas fa-times"></i>
    </button>
    <h2 class="card-title">
      <i class="fas fa-edit"></i>
      Edit Order
    </h2>
    <form id="editForm">
      <input type="hidden" id="editIndex">
      <div class="form-grid">
        <div class="form-group">
          <label for="editBrand">Brand</label>
          <input type="text" id="editBrand" value="CRISPY CHICKEN" class="fixed-brand" disabled>
        </div>
        <div class="form-group">
          <label for="editChannel">Channel</label>
          <select id="editChannel" class="channel-select" required>
            <option value="ONLY DELIVERY">ONLY DELIVERY</option>
            <option value="ONLINE-PICK-UP">ONLINE-PICK-UP</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editOrderNumber">Order Number</label>
          <input type="text" id="editOrderNumber" required>
        </div>
        <div class="form-group">
          <label for="editAgentName">Agent Name</label>
          <select id="editAgentName" class="agent-select" required>
            <option value="ANN">ANN</option>
            <option value="MANJO">MANJO</option>
            <option value="NONA">NONA</option>
            <option value="SHALH">SHALH</option>
            <option value="ASH">ASH</option>
            <option value="MELIVEN">MELIVEN</option>
            <option value="KENAWY">KENAWY</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editBranch">Location</label>
          <select id="editBranch" class="location-select" required>
            <option value="Barsha">Barsha</option>
            <option value="Electra">Electra</option>
            <option value="Hamdan">Hamdan</option>
            <option value="Khalydiha">Khalydiha</option>
            <option value="Mouroor">Mouroor</option>
            <option value="Shabiha">Shabiha</option>
            <option value="Satwa">Satwa</option>
            <option value="ALRIGGA">ALRIGGA</option>
            <option value="SHARJA">SHARJA</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editStatus">Status</label>
          <select id="editStatus" required onchange="toggleReasonStatusEdit()">
            <option value="cancelled">Cancelled</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editPrice">Order Price (AED)</label>
          <input type="number" id="editPrice" step="0.01" min="0" required>
        </div>
        <div class="form-group">
          <label for="editCount">Number of Orders</label>
          <input type="number" id="editCount" min="1" required>
        </div>
        <div class="form-group datetime-group">
          <div>
            <label for="editOrderDate">Order Date</label>
            <input type="date" id="editOrderDate" class="datetime-input" required>
          </div>
          <div>
            <label for="editOrderTime">Order Time</label>
            <input type="time" id="editOrderTime" class="datetime-input" required>
          </div>
        </div>
        <div class="form-group" id="editReasonGroup" style="display: none;">
          <label for="editReason">Reason for Cancellation</label>
          <select id="editReason" class="reason-select" onchange="toggleCustomReasonEdit()">
            <option value="Customer not available">Customer not available</option>
            <option value="Customer cancelled the order">Customer cancelled the order</option>
            <option value="Driver delayed">Driver delayed</option>
            <option value="Delivery issue">Delivery issue</option>
            <option value="Wrong order prepared">Wrong order prepared</option>
            <option value="Restaurant closed early">Restaurant closed early</option>
            <option value="Payment method not available">Payment method not available</option>
            <option value="Other reason (with details)">Other reason (with details)</option>
          </select>
        </div>
        <div class="form-group custom-reason" id="customReasonEditGroup">
          <label for="editCustomReason">Please specify the reason</label>
          <input type="text" id="editCustomReason" placeholder="e.g., Customer changed their mind">
        </div>
        <div class="form-group" id="editReasonStatusGroup" style="display: none;">
          <label for="editReasonStatus">Reason Status</label>
          <select id="editReasonStatus" class="status-select">
            <option value="">Select Status</option>
            <option value="ŸÖŸÇÿ®ŸàŸÑ ‚úÖ">ŸÖŸÇÿ®ŸàŸÑ ‚úÖ (Accepted - Valid/Justified)</option>
            <option value="ÿ∫Ÿäÿ± ŸÖŸÇÿ®ŸàŸÑ ‚ùå">ÿ∫Ÿäÿ± ŸÖŸÇÿ®ŸàŸÑ ‚ùå (Not Accepted - Unjustified)</option>
          </select>
        </div>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i>
          Save Changes
        </button>
        <button type="button" class="btn btn-secondary" onclick="setEditDateTimeNow()">
          <i class="fas fa-clock"></i>
          Use Current Date & Time
        </button>
      </div>
    </form>
  </div>
</div>

<script>
let orders = JSON.parse(localStorage.getItem('orders') || '[]');
let statusChart, channelChart, locationChart, trendChart;

// Set today's date as default for report
document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];

// Set current date and time on page load
window.addEventListener('DOMContentLoaded', function() {
  setDateTimeNow();
  renderTable();
  updateDashboard();
  generatePivotTable();
  updateCharts();
  generateReasonsTable('all');
});

// Function to set current date and time
function setDateTimeNow() {
  const now = new Date();
  const date = now.toISOString().split('T')[0];
  const time = now.toTimeString().slice(0, 5);
  
  document.getElementById('orderDate').value = date;
  document.getElementById('orderTime').value = time;
}

// Function to set current date and time in edit modal
function setEditDateTimeNow() {
  const now = new Date();
  const date = now.toISOString().split('T')[0];
  const time = now.toTimeString().slice(0, 5);
  
  document.getElementById('editOrderDate').value = date;
  document.getElementById('editOrderTime').value = time;
}

// Toggle reason status visibility based on order status
function toggleReasonStatus() {
  const status = document.getElementById('status').value;
  const reasonGroup = document.getElementById('reasonGroup');
  const reasonStatusGroup = document.getElementById('reasonStatusGroup');
  
  if (status === 'cancelled') {
    reasonGroup.style.display = 'block';
    reasonStatusGroup.style.display = 'block';
    document.getElementById('reason').required = true;
    document.getElementById('reasonStatus').required = true;
  } else {
    reasonGroup.style.display = 'none';
    reasonStatusGroup.style.display = 'none';
    document.getElementById('reason').required = false;
    document.getElementById('reasonStatus').required = false;
    document.getElementById('reason').value = '';
    document.getElementById('reasonStatus').value = '';
    document.getElementById('customReasonGroup').classList.remove('show');
    document.getElementById('customReason').value = '';
  }
}

// Toggle reason status visibility in edit modal
function toggleReasonStatusEdit() {
  const status = document.getElementById('editStatus').value;
  const reasonGroup = document.getElementById('editReasonGroup');
  const reasonStatusGroup = document.getElementById('editReasonStatusGroup');
  
  if (status === 'cancelled') {
    reasonGroup.style.display = 'block';
    reasonStatusGroup.style.display = 'block';
    document.getElementById('editReason').required = true;
    document.getElementById('editReasonStatus').required = true;
  } else {
    reasonGroup.style.display = 'none';
    reasonStatusGroup.style.display = 'none';
    document.getElementById('editReason').required = false;
    document.getElementById('editReasonStatus').required = false;
    document.getElementById('editReason').value = '';
    document.getElementById('editReasonStatus').value = '';
    document.getElementById('customReasonEditGroup').classList.remove('show');
    document.getElementById('editCustomReason').value = '';
  }
}

// Toggle custom reason input
function toggleCustomReason() {
  const reason = document.getElementById('reason').value;
  const customReasonGroup = document.getElementById('customReasonGroup');
  
  if (reason === 'Other reason (with details)') {
    customReasonGroup.classList.add('show');
    document.getElementById('customReason').required = true;
  } else {
    customReasonGroup.classList.remove('show');
    document.getElementById('customReason').required = false;
    document.getElementById('customReason').value = '';
  }
}

// Toggle custom reason input in edit modal
function toggleCustomReasonEdit() {
  const reason = document.getElementById('editReason').value;
  const customReasonGroup = document.getElementById('customReasonEditGroup');
  
  if (reason === 'Other reason (with details)') {
    customReasonGroup.classList.add('show');
    document.getElementById('editCustomReason').required = true;
  } else {
    customReasonGroup.classList.remove('show');
    document.getElementById('editCustomReason').required = false;
    document.getElementById('editCustomReason').value = '';
  }
}

// Generate WhatsApp report with new format
function generateWhatsAppReport() {
  const reportDate = document.getElementById('reportDate').value;
  if (!reportDate) {
    showNotification('Please select a date', 'error');
    return;
  }
  
  // Filter orders for the selected date
  const selectedDate = new Date(reportDate);
  const filteredOrders = orders.filter(order => {
    const orderDate = new Date(order.orderDate);
    return orderDate.toDateString() === selectedDate.toDateString() && order.status === 'cancelled';
  });
  
  // Group by location and then by channel
  const locations = ['Barsha', 'Electra', 'Hamdan', 'Khalydiha', 'Mouroor', 'Shabiha', 'Satwa', 'ALRIGGA', 'SHARJA'];
  const reportData = {};
  
  locations.forEach(location => {
    const locationOrders = filteredOrders.filter(order => order.branch === location);
    
    // Group by channel within this location
    const channels = ['ONLY DELIVERY', 'ONLINE-PICK-UP'];
    const channelData = {};
    
    channels.forEach(channel => {
      const channelOrders = locationOrders.filter(order => order.channel === channel);
      const total = channelOrders.length;
      const accepted = channelOrders.filter(order => order.reasonStatus === 'ŸÖŸÇÿ®ŸàŸÑ ‚úÖ').length;
      const notAccepted = channelOrders.filter(order => order.reasonStatus === 'ÿ∫Ÿäÿ± ŸÖŸÇÿ®ŸàŸÑ ‚ùå').length;
      
      // Get reasons with status indicators
      const reasons = {};
      channelOrders.forEach(order => {
        const statusIndicator = order.reasonStatus === 'ÿ∫Ÿäÿ± ŸÖŸÇÿ®ŸàŸÑ ‚ùå' ? ' ‚ùå' : '';
        if (!reasons[order.reason]) {
          reasons[order.reason] = 0;
        }
        reasons[order.reason]++;
      });
      
      if (total > 0) {
        channelData[channel] = {
          total,
          accepted,
          notAccepted,
          reasons
        };
      }
    });
    
    if (Object.keys(channelData).length > 0) {
      reportData[location] = channelData;
    }
  });
  
  // Format the report in the new structure
  const formattedDate = new Date(reportDate).toLocaleDateString('en-US', { 
    day: '2-digit', 
    month: 'short', 
    year: 'numeric' 
  });
  
  let reportText = `üìä Daily Cancellation Report ‚Äì ${formattedDate}\n\n`;
  
  for (const [location, channels] of Object.entries(reportData)) {
    reportText += `${location}:\n`;
    
    for (const [channel, data] of Object.entries(channels)) {
      reportText += `- ${channel}: ${data.total} order${data.total > 1 ? 's' : ''} (${data.accepted} ‚úÖ Accepted, ${data.notAccepted} ‚ùå Not Accepted)\n`;
      
      if (data.reasons) {
        reportText += `   ‚Ä¢ `;
        const reasonList = Object.entries(data.reasons).map(([reason, count]) => {
          const statusIndicator = data.reasons[reason] > 1 ? 's' : '';
          const status = data.reasons[reason] > 0 && data.notAccepted > 0 && data.reasons[reason] === data.notAccepted ? ' ‚ùå' : ' ‚úÖ';
          return `${reason} (${count})${statusIndicator}${status}`;
        });
        reportText += reasonList.join('\n   ‚Ä¢ ');
      }
      
      reportText += '\n';
    }
    
    reportText += '\n';
  }
  
  reportText += '‚ö†Ô∏è Notes:\n';
  reportText += '‚úÖ Accepted = no one is penalized.\n';
  reportText += '‚ùå Not Accepted = penalty charged to the responsible party (Delivery / Restaurant).\n\n';
  reportText += 'üìå Feature:\n';
  reportText += 'Each location shows its channels breakdown.\n';
  reportText += 'Each channel shows order count with ‚úÖ/‚ùå distribution.\n';
  reportText += 'Reasons are listed to clarify responsibility.';
  
  // Display the report
  document.getElementById('whatsappReportContent').textContent = reportText;
  document.getElementById('whatsappReportContainer').style.display = 'block';
  
  // Scroll to the report
  document.getElementById('whatsappReportContainer').scrollIntoView({ behavior: 'smooth' });
  
  showNotification('WhatsApp report generated successfully!', 'success');
}

// Copy to clipboard
function copyToClipboard() {
  const reportText = document.getElementById('whatsappReportContent').textContent;
  navigator.clipboard.writeText(reportText).then(() => {
    showNotification('Report copied to clipboard!', 'success');
  }).catch(err => {
    showNotification('Failed to copy to clipboard', 'error');
  });
}

// Open WhatsApp with pre-filled message
function openWhatsApp() {
  const reportText = document.getElementById('whatsappReportContent').textContent;
  const encodedText = encodeURIComponent(reportText);
  const whatsappUrl = `https://wa.me/?text=${encodedText}`;
  window.open(whatsappUrl, '_blank');
}

// Add new order
document.getElementById('orderForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const brand = document.getElementById('brand').value.trim();
  const channel = document.getElementById('channel').value;
  const orderNumber = document.getElementById('orderNumber').value.trim();
  const agentName = document.getElementById('agentName').value;
  const branch = document.getElementById('branch').value;
  const status = document.getElementById('status').value;
  const price = parseFloat(document.getElementById('price').value) || 0;
  const count = parseInt(document.getElementById('count').value) || 1;
  const orderDate = document.getElementById('orderDate').value;
  const orderTime = document.getElementById('orderTime').value;
  const reason = document.getElementById('reason').value;
  const customReason = document.getElementById('customReason').value.trim();
  const reasonStatus = document.getElementById('reasonStatus').value;
  
  // Validate required fields
  if (!channel || !orderNumber || !agentName || !branch || !status || !orderDate || !orderTime) {
    showNotification('Please fill in all required fields', 'error');
    return;
  }
  
  // Validate reason fields only for cancelled orders
  if (status === 'cancelled') {
    if (!reason) {
      showNotification('Please select a reason for cancelled orders', 'error');
      return;
    }
    if (!reasonStatus) {
      showNotification('Please select a reason status for cancelled orders', 'error');
      return;
    }
    if (reason === 'Other reason (with details)' && !customReason) {
      showNotification('Please specify the custom reason', 'error');
      return;
    }
  }
  
  const finalReason = (status === 'cancelled' && reason === 'Other reason (with details)') ? customReason : reason;
  const reasonCategory = (status === 'cancelled') ? (reason === 'Other reason (with details)' ? 'Other' : reason) : '';
  
  const newOrder = {
    id: Date.now(),
    brand,
    channel,
    orderNumber,
    agentName,
    branch,
    status,
    price,
    count,
    total: price * count,
    orderDate,
    orderTime,
    reason: finalReason,
    reasonCategory,
    reasonStatus: status === 'cancelled' ? reasonStatus : ''
  };
  
  orders.push(newOrder);
  localStorage.setItem('orders', JSON.stringify(orders));
  
  // Reset form
  this.reset();
  document.getElementById('customReasonGroup').classList.remove('show');
  document.getElementById('reasonGroup').style.display = 'none';
  document.getElementById('reasonStatusGroup').style.display = 'none';
  
  // Set current date and time again
  setDateTimeNow();
  
  // Update all displays
  renderTable();
  updateDashboard();
  generatePivotTable();
  updateCharts();
  generateReasonsTable('all');
  
  showNotification('Order added successfully!');
});

// Render table
function renderTable() {
  const tbody = document.getElementById('ordersTable');
  tbody.innerHTML = '';
  
  const filterBranch = document.getElementById('filterBranch').value;
  const filterSearch = document.getElementById('filterSearch').value.toLowerCase();
  const filterChannel = document.getElementById('filterChannel').value;
  const filterAgent = document.getElementById('filterAgent').value;
  const filterStatus = document.getElementById('filterStatus').value;
  const filterReasonStatus = document.getElementById('filterReasonStatus').value;
  
  const filteredOrders = orders.filter(order => {
    const matchChannel = !filterChannel || order.channel === filterChannel;
    const matchBranch = !filterBranch || order.branch === filterBranch;
    const matchAgent = !filterAgent || order.agentName === filterAgent;
    const matchStatus = !filterStatus || order.status === filterStatus;
    const matchReasonStatus = !filterReasonStatus || order.reasonStatus === filterReasonStatus;
    const matchSearch = !filterSearch ||
      order.channel.toLowerCase().includes(filterSearch) ||
      order.branch.toLowerCase().includes(filterSearch) ||
      (order.reason && order.reason.toLowerCase().includes(filterSearch)) ||
      (order.reasonCategory && order.reasonCategory.toLowerCase().includes(filterSearch)) ||
      (order.orderNumber && order.orderNumber.toLowerCase().includes(filterSearch)) ||
      (order.agentName && order.agentName.toLowerCase().includes(filterSearch)) ||
      (order.orderDate && order.orderDate.includes(filterSearch)) ||
      (order.orderTime && order.orderTime.includes(filterSearch));
      
    return matchChannel && matchBranch && matchAgent && matchStatus && matchReasonStatus && matchSearch;
  });
  
  // Sort orders by date and time (newest first)
  filteredOrders.sort((a, b) => {
    const dateA = new Date(`${a.orderDate} ${a.orderTime}`);
    const dateB = new Date(`${b.orderDate} ${b.orderTime}`);
    return dateB - dateA;
  });
  
  filteredOrders.forEach((order, index) => {
    const actualIndex = orders.findIndex(o => o.id === order.id);
    
    // Get reason category badge
    let reasonBadge = '';
    if (order.reasonCategory) {
      const category = order.reasonCategory;
      let badgeClass = 'other';
      
      if (category.includes('Customer')) badgeClass = 'customer';
      else if (category.includes('Driver')) badgeClass = 'driver';
      else if (category.includes('Delivery')) badgeClass = 'delivery';
      else if (category.includes('Restaurant')) badgeClass = 'restaurant';
      else if (category.includes('Payment')) badgeClass = 'payment';
      
      reasonBadge = `<span class="reason-badge ${badgeClass}">${category}</span>`;
    }
    
    // Get status badge with styling
    let statusBadge = '';
    if (order.reasonStatus) {
      const statusClass = order.reasonStatus === 'ŸÖŸÇÿ®ŸàŸÑ ‚úÖ' ? 'accepted' : 'not-accepted';
      const statusText = order.reasonStatus === 'ŸÖŸÇÿ®ŸàŸÑ ‚úÖ' ? 'Accepted' : 'Not Accepted';
      statusBadge = `<span class="status-badge ${statusClass}">${order.reasonStatus} ${statusText}</span>`;
    }
    
    tbody.innerHTML += `
      <tr>
        <td>${order.brand}</td>
        <td><strong>${order.orderNumber}</strong></td>
        <td>${order.channel}</td>
        <td>${order.agentName}</td>
        <td>${order.branch}</td>
        <td>
          <span class="badge ${order.status === 'cancelled' ? 'badge-danger' : 'badge-success'}">
            ${order.status === 'cancelled' ? 'Cancelled' : 'Delivered'}
          </span>
        </td>
        <td>AED ${order.price.toFixed(2)}</td>
        <td>${order.count}</td>
        <td>${order.orderDate}</td>
        <td>${order.orderTime}</td>
        <td>
          ${reasonBadge}
          ${order.reason ? `<br>${order.reason}` : ''}
        </td>
        <td>${statusBadge}</td>
        <td>
          <div class="actions">
            <button class="btn btn-info" onclick="editOrder(${actualIndex})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger" onclick="deleteOrder(${actualIndex})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  });
}

// Enhanced Dashboard Update
function updateDashboard() {
  const total = orders.length;
  const cancelled = orders.filter(o => o.status === 'cancelled').length;
  const delivered = orders.filter(o => o.status === 'delivered').length;
  const rate = total ? ((cancelled/total)*100).toFixed(1) : 0;
  const unjustified = orders.filter(o => o.reasonStatus === 'ÿ∫Ÿäÿ± ŸÖŸÇÿ®ŸàŸÑ ‚ùå').length;
  const unjustifiedRate = cancelled ? ((unjustified/cancelled)*100).toFixed(1) : 0;
  const totalRevenue = orders.reduce((sum, o) => sum + o.total, 0);
  const avgOrderValue = total ? (totalRevenue / total).toFixed(2) : 0;
  
  // Update main dashboard cards
  document.getElementById('totalOrders').textContent = total;
  document.getElementById('cancelledOrders').textContent = cancelled;
  document.getElementById('deliveredOrders').textContent = delivered;
  document.getElementById('cancellationRate').textContent = rate + '%';
  document.getElementById('unjustifiedCancellations').textContent = unjustified;
  document.getElementById('totalRevenue').textContent = `AED ${totalRevenue.toFixed(2)}`;
  
  // Update KPI cards
  const today = new Date().toISOString().split('T')[0];
  const todayOrders = orders.filter(o => o.orderDate === today);
  const todayCancelled = todayOrders.filter(o => o.status === 'cancelled');
  const todayDelivered = todayOrders.filter(o => o.status === 'delivered');
  const todayRevenue = todayOrders.reduce((sum, o) => sum + o.total, 0);
  const todayAvgValue = todayOrders.length ? (todayRevenue / todayOrders.length).toFixed(2) : 0;
  
  document.getElementById('todayOrders').textContent = todayOrders.length;
  document.getElementById('todayCancellations').textContent = todayCancelled.length;
  document.getElementById('avgOrderValue').textContent = `AED ${todayAvgValue}`;
  document.getElementById('unjustifiedRate').textContent = unjustifiedRate + '%';
  
  // Calculate changes (compared to yesterday)
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toISOString().split('T')[0];
  const yesterdayOrders = orders.filter(o => o.orderDate === yesterdayStr);
  const yesterdayCancelled = yesterdayOrders.filter(o => o.status === 'cancelled');
  const yesterdayRevenue = yesterdayOrders.reduce((sum, o) => sum + o.total, 0);
  const yesterdayAvgValue = yesterdayOrders.length ? (yesterdayRevenue / yesterdayOrders.length).toFixed(2) : 0;
  
  // Update change indicators
  const ordersChange = yesterdayOrders.length ? 
    (((todayOrders.length - yesterdayOrders.length) / yesterdayOrders.length) * 100).toFixed(0) : 0;
  const cancellationsChange = yesterdayCancelled.length ? 
    (((todayCancelled.length - yesterdayCancelled.length) / yesterdayCancelled.length) * 100).toFixed(0) : 0;
  const avgValueChange = yesterdayAvgValue ? 
    (((todayAvgValue - yesterdayAvgValue) / yesterdayAvgValue) * 100).toFixed(0) : 0;
  
  document.getElementById('todayOrdersChange').textContent = `${ordersChange >= 0 ? '+' : ''}${ordersChange}%`;
  document.getElementById('todayCancellationsChange').textContent = `${cancellationsChange >= 0 ? '+' : ''}${cancellationsChange}%`;
  document.getElementById('avgOrderValueChange').textContent = `${avgValueChange >= 0 ? '+' : ''}${avgValueChange}%`;
  document.getElementById('unjustifiedRateChange').textContent = '0%';
  
  // Update KPI card classes
  const todayOrdersCard = document.querySelector('.kpi-card:nth-child(1)');
  const todayCancellationsCard = document.querySelector('.kpi-card:nth-child(2)');
  const avgOrderValueCard = document.querySelector('.kpi-card:nth-child(3)');
  const unjustifiedRateCard = document.querySelector('.kpi-card:nth-child(4)');
  
  todayOrdersCard.className = ordersChange >= 0 ? 'kpi-card positive' : 'kpi-card negative';
  todayCancellationsCard.className = cancellationsChange <= 0 ? 'kpi-card positive' : 'kpi-card negative';
  avgOrderValueCard.className = avgValueChange >= 0 ? 'kpi-card positive' : 'kpi-card negative';
  unjustifiedRateCard.className = 'kpi-card negative';
}

// Generate pivot table
function generatePivotTable() {
  const locations = ['Barsha', 'Electra', 'Hamdan', 'Khalydiha', 'Mouroor', 'Shabiha', 'Satwa', 'ALRIGGA', 'SHARJA'];
  const channels = ['ONLY DELIVERY', 'ONLINE-PICK-UP'];
  const tbody = document.getElementById('pivotTableBody');
  tbody.innerHTML = '';
  
  locations.forEach(location => {
    const row = document.createElement('tr');
    row.innerHTML = `<td><strong>${location}</strong></td>`;
    
    let locationTotal = 0;
    channels.forEach(channel => {
      const channelOrders = orders.filter(o => o.branch === location && o.channel === channel);
      const totalOrders = channelOrders.reduce((sum, o) => sum + o.count, 0);
      const totalPrice = channelOrders.reduce((sum, o) => sum + o.total, 0);
      const unacceptableCount = channelOrders.filter(o => o.reasonStatus === 'ÿ∫Ÿäÿ± ŸÖŸÇÿ®ŸàŸÑ ‚ùå').length;
      
      locationTotal += totalOrders;
      
      let cellContent = `${totalOrders}<br>AED ${totalPrice.toFixed(2)}`;
      if (unacceptableCount > 0) {
        cellContent += `<br><span class="badge badge-danger">${unacceptableCount} ‚ùå</span>`;
      }
      
      row.innerHTML += `<td>${cellContent}</td>`;
    });
    
    // Add total column
    row.innerHTML += `<td><strong>${locationTotal}</strong></td>`;
    tbody.appendChild(row);
  });
}

// Update charts
function updateCharts() {
  // Status Chart (Doughnut)
  const statusData = {
    delivered: orders.filter(o => o.status === 'delivered').length,
    cancelled: orders.filter(o => o.status === 'cancelled').length
  };
  
  if (statusChart) statusChart.destroy();
  
  const statusCtx = document.getElementById('statusChart').getContext('2d');
  statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
      labels: ['Delivered', 'Cancelled'],
      datasets: [{
        data: [statusData.delivered, statusData.cancelled],
        backgroundColor: ['#28a745', '#dc3545'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.raw / total) * 100).toFixed(1);
              return `${context.label}: ${context.raw} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
  
  // Channel Chart (Bar)
  const channelData = {};
  const channels = ['ONLY DELIVERY', 'ONLINE-PICK-UP'];
  
  channels.forEach(channel => {
    const channelOrders = orders.filter(o => o.channel === channel);
    const cancelled = channelOrders.filter(o => o.status === 'cancelled').length;
    const total = channelOrders.length;
    const rate = total ? (cancelled / total) * 100 : 0;
    channelData[channel] = { cancelled, total, rate };
  });
  
  if (channelChart) channelChart.destroy();
  
  const channelCtx = document.getElementById('channelChart').getContext('2d');
  channelChart = new Chart(channelCtx, {
    type: 'bar',
    data: {
      labels: Object.keys(channelData),
      datasets: [{
        label: 'Cancellation Rate (%)',
        data: Object.values(channelData).map(d => d.rate),
        backgroundColor: ['#ff6b35', '#f7931e'],
        borderColor: ['#e55a2b', '#e5821e'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            callback: function(value) {
              return value + '%';
            }
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const data = channelData[context.label];
              return [
                `Rate: ${context.raw.toFixed(1)}%`,
                `Cancelled: ${data.cancelled}`,
                `Total: ${data.total}`
              ];
            }
          }
        }
      }
    }
  });
  
  // Location Chart (Horizontal Bar)
  const locationData = {};
  const locations = ['Barsha', 'Electra', 'Hamdan', 'Khalydiha', 'Mouroor', 'Shabiha', 'Satwa', 'ALRIGGA', 'SHARJA'];
  
  locations.forEach(location => {
    const locationOrders = orders.filter(o => o.branch === location);
    const cancelled = locationOrders.filter(o => o.status === 'cancelled').length;
    locationData[location] = cancelled;
  });
  
  if (locationChart) locationChart.destroy();
  
  const locationCtx = document.getElementById('locationChart').getContext('2d');
  locationChart = new Chart(locationCtx, {
    type: 'bar',
    data: {
      labels: Object.keys(locationData),
      datasets: [{
        label: 'Cancelled Orders',
        data: Object.values(locationData),
        backgroundColor: '#ff6b35',
        borderColor: '#e55a2b',
        borderWidth: 2
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      }
    }
  });
  
  // Trend Chart (Line - Last 7 Days)
  const trendData = [];
  const labels = [];
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];
    const dayOrders = orders.filter(o => o.orderDate === dateStr);
    
    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    trendData.push({
      total: dayOrders.length,
      cancelled: dayOrders.filter(o => o.status === 'cancelled').length,
      delivered: dayOrders.filter(o => o.status === 'delivered').length
    });
  }
  
  if (trendChart) trendChart.destroy();
  
  const trendCtx = document.getElementById('trendChart').getContext('2d');
  trendChart = new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Total Orders',
          data: trendData.map(d => d.total),
          borderColor: '#17a2b8',
          backgroundColor: 'rgba(23, 162, 184, 0.1)',
          tension: 0.4,
          fill: true
        },
        {
          label: 'Delivered',
          data: trendData.map(d => d.delivered),
          borderColor: '#28a745',
          backgroundColor: 'rgba(40, 167, 69, 0.1)',
          tension: 0.4,
          fill: true
        },
        {
          label: 'Cancelled',
          data: trendData.map(d => d.cancelled),
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}

// Generate reasons table
function generateReasonsTable(timeFilter) {
  const tbody = document.getElementById('reasonsTable');
  tbody.innerHTML = '';
  
  let filteredOrders = orders;
  
  if (timeFilter === 'week') {
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    filteredOrders = orders.filter(o => new Date(`${o.orderDate} ${o.orderTime}`) >= oneWeekAgo);
  } else if (timeFilter === 'month') {
    const oneMonthAgo = new Date();
    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
    filteredOrders = orders.filter(o => new Date(`${o.orderDate} ${o.orderTime}`) >= oneMonthAgo);
  }
  
  const unacceptableOrders = filteredOrders.filter(o => o.reasonStatus === 'ÿ∫Ÿäÿ± ŸÖŸÇÿ®ŸàŸÑ ‚ùå');
  const reasonCounts = {};
  const categoryCounts = {};
  
  unacceptableOrders.forEach(order => {
    if (order.reasonCategory) {
      categoryCounts[order.reasonCategory] = (categoryCounts[order.reasonCategory] || 0) + 1;
      
      if (order.reason) {
        const key = order.reasonCategory;
        if (!reasonCounts[key]) {
          reasonCounts[key] = {};
        }
        reasonCounts[key][order.reason] = (reasonCounts[key][order.reason] || 0) + 1;
      }
    }
  });
  
  // Sort categories by count
  const sortedCategories = Object.entries(categoryCounts)
    .sort((a, b) => b[1] - a[1]);
  
  let rank = 1;
  sortedCategories.forEach(([category, count]) => {
    const percentage = unacceptableOrders.length > 0 ? ((count / unacceptableOrders.length) * 100).toFixed(1) : 0;
    
    // Add category row
    tbody.innerHTML += `
      <tr>
        <td>${rank}</td>
        <td colspan="2">
          <span class="reason-badge ${getCategoryClass(category)}">${category}</span>
          <strong>Total: ${count}</strong>
        </td>
        <td>${count}</td>
        <td>${percentage}%</td>
      </tr>
    `;
    
    // Add top reasons for this category
    if (reasonCounts[category]) {
      const sortedReasons = Object.entries(reasonCounts[category])
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);
      
      sortedReasons.forEach(([reason, count]) => {
        const percentage = unacceptableOrders.length > 0 ? ((count / unacceptableOrders.length) * 100).toFixed(1) : 0;
        tbody.innerHTML += `
          <tr>
            <td></td>
            <td>${category}</td>
            <td>${reason}</td>
            <td>${count}</td>
            <td>${percentage}%</td>
          </tr>
        `;
      });
    }
    
    rank++;
  });
  
  if (sortedCategories.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No unacceptable reasons found</td></tr>';
  }
}

// Get category class for badge styling
function getCategoryClass(category) {
  if (category.includes('Customer')) return 'customer';
  if (category.includes('Driver')) return 'driver';
  if (category.includes('Delivery')) return 'delivery';
  if (category.includes('Restaurant')) return 'restaurant';
  if (category.includes('Payment')) return 'payment';
  return 'other';
}

// Filter reasons by time
function filterReasons(timeFilter) {
  // Update active button
  document.querySelectorAll('.time-filter button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  generateReasonsTable(timeFilter);
}

// Delete order
function deleteOrder(index) {
  if (confirm('Are you sure you want to delete this order?')) {
    orders.splice(index, 1);
    localStorage.setItem('orders', JSON.stringify(orders));
    renderTable();
    updateDashboard();
    generatePivotTable();
    updateCharts();
    generateReasonsTable('all');
    showNotification('Order deleted successfully!');
  }
}

// Edit order
function editOrder(index) {
  const order = orders[index];
  document.getElementById('editIndex').value = index;
  document.getElementById('editBrand').value = order.brand;
  document.getElementById('editChannel').value = order.channel;
  document.getElementById('editOrderNumber').value = order.orderNumber;
  document.getElementById('editAgentName').value = order.agentName;
  document.getElementById('editBranch').value = order.branch;
  document.getElementById('editStatus').value = order.status;
  document.getElementById('editPrice').value = order.price;
  document.getElementById('editCount').value = order.count;
  document.getElementById('editOrderDate').value = order.orderDate;
  document.getElementById('editOrderTime').value = order.orderTime;
  
  // Set reason and custom reason
  if (order.status === 'cancelled') {
    document.getElementById('editReason').value = order.reasonCategory || 'Other reason (with details)';
    toggleCustomReasonEdit();
    
    if (order.reasonCategory === 'Other') {
      document.getElementById('editCustomReason').value = order.reason || '';
    }
    
    // Set reason status
    document.getElementById('editReasonStatus').value = order.reasonStatus || '';
  }
  
  toggleReasonStatusEdit();
  
  document.getElementById('editModal').style.display = 'flex';
}

// Save edit
document.getElementById('editForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const index = parseInt(document.getElementById('editIndex').value);
  const brand = document.getElementById('editBrand').value.trim();
  const channel = document.getElementById('editChannel').value;
  const orderNumber = document.getElementById('editOrderNumber').value.trim();
  const agentName = document.getElementById('editAgentName').value;
  const branch = document.getElementById('editBranch').value;
  const status = document.getElementById('editStatus').value;
  const price = parseFloat(document.getElementById('editPrice').value) || 0;
  const count = parseInt(document.getElementById('editCount').value) || 1;
  const orderDate = document.getElementById('editOrderDate').value;
  const orderTime = document.getElementById('editOrderTime').value;
  const reason = document.getElementById('editReason').value;
  const customReason = document.getElementById('editCustomReason').value.trim();
  const reasonStatus = document.getElementById('editReasonStatus').value;
  
  // Validate required fields
  if (!channel || !orderNumber || !agentName || !branch || !status || !orderDate || !orderTime) {
    showNotification('Please fill in all required fields', 'error');
    return;
  }
  
  // Validate reason fields only for cancelled orders
  if (status === 'cancelled') {
    if (!reason) {
      showNotification('Please select a reason for cancelled orders', 'error');
      return;
    }
    if (!reasonStatus) {
      showNotification('Please select a reason status for cancelled orders', 'error');
      return;
    }
    if (reason === 'Other reason (with details)' && !customReason) {
      showNotification('Please specify the custom reason', 'error');
      return;
    }
  }
  
  const finalReason = (status === 'cancelled' && reason === 'Other reason (with details)') ? customReason : reason;
  const reasonCategory = (status === 'cancelled') ? (reason === 'Other reason (with details)' ? 'Other' : reason) : '';
  
  orders[index] = {
    ...orders[index],
    brand,
    channel,
    orderNumber,
    agentName,
    branch,
    status,
    price,
    count,
    total: price * count,
    orderDate,
    orderTime,
    reason: finalReason,
    reasonCategory,
    reasonStatus: status === 'cancelled' ? reasonStatus : ''
  };
  
  localStorage.setItem('orders', JSON.stringify(orders));
  renderTable();
  updateDashboard();
  generatePivotTable();
  updateCharts();
  generateReasonsTable('all');
  closeEditModal();
  showNotification('Order updated successfully!');
});

// Close edit modal
function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
}

// Reset filters
function resetFilters() {
  document.getElementById('filterBranch').value = '';
  document.getElementById('filterSearch').value = '';
  document.getElementById('filterChannel').value = '';
  document.getElementById('filterAgent').value = '';
  document.getElementById('filterStatus').value = '';
  document.getElementById('filterReasonStatus').value = '';
  renderTable();
  showNotification('Filters reset', 'info');
}

// Export to CSV
function exportToCSV() {
  try {
    let csv = 'Brand,Order Number,Channel,Agent Name,Location,Status,Order Price,Number of Orders,Order Date,Order Time,Reason Category,Reason,Reason Status,Total\n';
    orders.forEach(order => {
      csv += `${order.brand},${order.orderNumber},${order.channel},${order.agentName},${order.branch},${order.status},${order.price},${order.count},${order.orderDate},${order.orderTime},"${order.reasonCategory || ''}","${order.reason || ''}","${order.reasonStatus || ''}",${order.total}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
    
    showNotification('CSV exported successfully!');
  } catch (error) {
    showNotification('Failed to export CSV', 'error');
    console.error('CSV export error:', error);
  }
}

// Export to PDF
function exportToPDF() {
  try {
    showNotification('Generating PDF report...', 'info');
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Add title
    doc.setFontSize(20);
    doc.text('CRISPY CHICKEN - Orders Report', 105, 20, { align: 'center' });
    
    // Add date
    doc.setFontSize(12);
    doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 30, { align: 'center' });
    
    // Add summary
    let yPosition = 50;
    doc.setFontSize(14);
    doc.text('Summary:', 20, yPosition);
    yPosition += 10;
    
    doc.setFontSize(11);
    const total = orders.length;
    const cancelled = orders.filter(o => o.status === 'cancelled').length;
    const delivered = orders.filter(o => o.status === 'delivered').length;
    const rate = total ? ((cancelled/total)*100).toFixed(1) : 0;
    const unjustified = orders.filter(o => o.reasonStatus === 'ÿ∫Ÿäÿ± ŸÖŸÇÿ®ŸàŸÑ ‚ùå').length;
    const totalRevenue = orders.reduce((sum, o) => sum + o.total, 0);
    
    doc.text(`Total Orders: ${total}`, 30, yPosition);
    yPosition += 7;
    doc.text(`Cancelled Orders: ${cancelled}`, 30, yPosition);
    yPosition += 7;
    doc.text(`Delivered Orders: ${delivered}`, 30, yPosition);
    yPosition += 7;
    doc.text(`Cancellation Rate: ${rate}%`, 30, yPosition);
    yPosition += 7;
    doc.text(`Unjustified Cancellations: ${unjustified}`, 30, yPosition);
    yPosition += 7;
    doc.text(`Total Revenue: AED ${totalRevenue.toFixed(2)}`, 30, yPosition);
    
    // Add orders table
    yPosition += 15;
    doc.setFontSize(14);
    doc.text('Orders List:', 20, yPosition);
    yPosition += 10;
    
    doc.setFontSize(10);
    const headers = ['Order #', 'Channel', 'Agent', 'Location', 'Status', 'Price', 'Date', 'Time'];
    let xPosition = 20;
    headers.forEach(header => {
      doc.text(header, xPosition, yPosition);
      xPosition += 22;
    });
    yPosition += 7;
    
    orders.forEach(order => {
      if (yPosition > 270) {
        doc.addPage();
        yPosition = 20;
      }
      
      xPosition = 20;
      doc.text(order.orderNumber.substring(0, 8), xPosition, yPosition);
      xPosition += 22;
      doc.text(order.channel.substring(0, 8), xPosition, yPosition);
      xPosition += 22;
      doc.text(order.agentName, xPosition, yPosition);
      xPosition += 22;
      doc.text(order.branch.substring(0, 8), xPosition, yPosition);
      xPosition += 22;
      doc.text(order.status, xPosition, yPosition);
      xPosition += 22;
      doc.text(`AED${order.price}`, xPosition, yPosition);
      xPosition += 22;
      doc.text(order.orderDate, xPosition, yPosition);
      xPosition += 22;
      doc.text(order.orderTime, xPosition, yPosition);
      
      yPosition += 6;
    });
    
    doc.save(`orders_report_${new Date().toISOString().split('T')[0]}.pdf`);
    showNotification('PDF exported successfully!');
  } catch (error) {
    showNotification('Failed to export PDF', 'error');
    console.error('PDF export error:', error);
  }
}

// Export to JSON
function exportToJSON() {
  try {
    const dataStr = JSON.stringify(orders, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `orders_${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification('JSON exported successfully!');
  } catch (error) {
    showNotification('Failed to export JSON', 'error');
    console.error('JSON export error:', error);
  }
}

// Show notification
function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  const notificationText = document.getElementById('notificationText');
  
  notification.className = 'notification show';
  if (type === 'error') notification.classList.add('error');
  if (type === 'info') notification.classList.add('info');
  
  notificationText.textContent = message;
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}
</script>
</body>
</html>
